<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asta Fantacalcio 2025/26</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js"></script>
</head>
<body>
  <header><h1>Asta Fantacalcio 2025/26</h1></header>

  <main>
    <section id="login">
      <h2>Accedi o Registrati</h2>
      <input id="nickname" placeholder="Nickname" />
      <input id="teamName" placeholder="Nome Squadra" />
      <button id="btnLogin">Entra</button>
    </section>

    <section id="auction" class="hidden">
      <div id="auction-controls">
        <select id="roleSelect">
          <option value="P">Portieri</option>
          <option value="D">Difensori</option>
          <option value="C">Centrocampisti</option>
          <option value="A">Attaccanti</option>
        </select>
        <button id="btnNext">Prossimo</button>
        <button id="btnAssign">Assegna</button>
        <button id="btnDiscard">Scarta</button>
      </div>

      <div id="playerCard">
        <h3 id="playerName"></h3>
        <p id="playerQuota"></p>
      </div>

      <div id="bids">
        <button class="bid-btn" data-incr="1">+1</button>
        <button class="bid-btn" data-incr="5">+5</button>
        <button class="bid-btn" data-incr="10">+10</button>
        <button class="bid-btn" data-incr="50">+50</button>
      </div>

      <div id="bidHistory">
        <h4>Ultimi 5 Rilanci</h4>
        <ul id="historyList"></ul>
      </div>

      <div id="teamsStatus">
        <h4>Crediti Residui</h4>
        <table id="statusTable">
          <thead><tr><th>Squadra</th><th>Crediti</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="chat">
        <h4>Chat Asta</h4>
        <div id="chatMessages"></div>
        <input id="chatInput" placeholder="Scrivi..." />
        <button id="btnSend">Invia</button>
      </div>
    </section>

    <section id="dashboard" class="hidden">
      <h2>La Mia Squadra</h2>
      <canvas id="budgetChart"></canvas>

      <h3>Dettaglio Rose</h3>
      <table id="rosterTable">
        <thead><tr><th>Ruolo</th><th>Giocatore</th><th>Crediti</th></tr></thead>
        <tbody></tbody>
      </table>

      <button id="btnExport">Esporta Rosters</button>
    </section>

    <section id="admin" class="hidden">
      <h2>Area Admin</h2>
      <button id="btnReset">Reset Asta</button>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCQyptj9TKJWtb2R1v81I_w4M8KdhlDbDM",
      authDomain: "astafantacalcio-387cf.firebaseapp.com",
      databaseURL: "https://astafantacalcio-387cf-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "astafantacalcio-387cf",
      storageBucket: "astafantacalcio-387cf.firebasestorage.app",
      messagingSenderId: "826628958189",
      appId: "1:826628958189:web:dd741f447550d3259769e4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loginSection = document.getElementById("login");
    const auctionSection = document.getElementById("auction");
    const dashboardSection = document.getElementById("dashboard");
    const adminSection = document.getElementById("admin");
    const btnLogin = document.getElementById("btnLogin");

    let currentUser = null;
    let currentTeam = null;

    function showSection(name) {
      loginSection.classList.toggle("hidden", name !== "login");
      auctionSection.classList.toggle("hidden", name !== "auction");
      dashboardSection.classList.toggle("hidden", name !== "dashboard");
      adminSection.classList.toggle("hidden", name !== "admin");
    }

    btnLogin.onclick = async () => {
      const nick = document.getElementById("nickname").value.trim();
      const team = document.getElementById("teamName").value.trim();
      if (!nick || !team) {
        alert("Inserisci nickname e nome squadra");
        return;
      }
      await signInAnonymously(auth);
      onAuthStateChanged(auth, user => {
        if (user) {
          currentUser = user;
          currentTeam = { teamName: team, nickname: nick, budget: 1500, roster: { P: [], D: [], C: [], A: [] } };
          set(ref(db, `users/${user.uid}`), currentTeam);
          showSection("auction");
        }
      });
    };

    // Asta
    const playerNameEl = document.getElementById("playerName");
    const playerQuotaEl = document.getElementById("playerQuota");
    const historyListEl = document.getElementById("historyList");
    const roleSelectEl = document.getElementById("roleSelect");

    let playersByRole = { P: [], D: [], C: [], A: [] };
    let currentPlayer = null;

    async function loadPlayers() {
      const res = await fetch("data/players.csv");
      const text = await res.text();
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      const idx = { Id: headers.indexOf("Id"), R: headers.indexOf("R"),
        Nome: headers.indexOf("Nome"), Squadra: headers.indexOf("Squadra"),
        Quota: headers.indexOf("QuotaIniziale")
      };
      lines.slice(1).forEach(line => {
        const cols = line.split(",");
        const rec = {
          id: cols[idx.Id],
          role: cols[idx.R],
          nome: cols[idx.Nome],
          squadra: cols[idx.Squadra],
          quota: Number(cols[idx.Quota])
        };
        playersByRole[rec.role].push(rec);
      });
    }

    function pickNextPlayer() {
      const role = roleSelectEl.value;
      const list = playersByRole[role] || [];
      if (!list.length) {
        alert("Nessun giocatore rimasto");
        return;
      }
      const i = Math.floor(Math.random() * list.length);
      currentPlayer = list.splice(i, 1)[0];
      playerNameEl.textContent = `${currentPlayer.nome} (${currentPlayer.squadra})`;
      playerQuotaEl.textContent = `Base: ${currentPlayer.quota}`;
      historyListEl.innerHTML = "";
    }

    function refreshHistory() {
      onValue(ref(db, `bids/${currentPlayer.id}`), snap => {
        const arr = Object.values(snap.val() || {}).sort((a, b) => b.ts - a.ts).slice(0, 5);
        historyListEl.innerHTML = arr.map(b => `<li>${b.team}: ${b.amount}</li>`).join("");
      });
    }

    function placeBid(incr) {
      if (!currentPlayer) return;
      currentPlayer.quota += incr;
      push(ref(db, `bids/${currentPlayer.id}`), {
        team: currentTeam.teamName,
        amount: currentPlayer.quota,
        ts: Date.now()
      });
      refreshHistory();
    }

    function assignPlayer() {
      onValue(ref(db, `bids/${currentPlayer.id}`), snap => {
        const bids = Object.values(snap.val() || {});
        if (!bids.length) {
          alert("Nessuna offerta");
          return;
        }
        const winner = bids.sort((a, b) => b.amount - a.amount)[0];
        onValue(ref(db, "users"), usersSnap => {
          const users = usersSnap.val() || {};
          const uid = Object.keys(users).find(k => users[k].teamName === winner.team);
          if (!uid) return alert("Utente non trovato");
          push(ref(db, `users/${uid}/roster/${roleSelectEl.value}`), {
            id: currentPlayer.id,
            nome: currentPlayer.nome,
            squadra: currentPlayer.squadra,
            quota: winner.amount
          });
          update(ref(db, `users/${uid}`), { budget: users[uid].budget - winner.amount });
          pickNextPlayer();
        }, { onlyOnce: true });
      }, { onlyOnce: true });
    }

    function discardPlayer() {
      push(ref(db, `discarded/${roleSelectEl.value}`), currentPlayer.id);
      pickNextPlayer();
    }

    function updateTeamsStatus() {
      onValue(ref(db, "users"), snap => {
        const tbody = document.querySelector("#statusTable tbody");
        const users = snap.val() || {};
        tbody.innerHTML = Object.values(users).map(u =>
          `<tr><td>${u.teamName}</td><td>${u.budget}</td></tr>`
        ).join("");
      });
    }

    document.getElementById("btnNext").onclick = pickNextPlayer;
    document.querySelectorAll(".bid-btn").forEach(b => b.onclick = () => placeBid(+b.dataset.incr));
    document.getElementById("btnAssign").onclick = assignPlayer;
    document.getElementById("btnDiscard").onclick = discardPlayer;

    // Chat
    const chatInput = document.getElementById("chatInput");
    const chatBox = document.getElementById("chatMessages");
    document.getElementById("btnSend").onclick = () => {
      const t = chatInput.value.trim();
      if (!t) return;
      push(ref(db, "chat"), { team: currentTeam.teamName, text: t, ts: Date.now() });
      chatInput.value = "";
    };
    onValue(ref(db, "chat"), snap => {
      const msgs = Object.values(snap.val() || {}).sort((a, b) => a.ts - b.ts);
      chatBox.innerHTML = msgs.map(m => `<p><strong>${m.team}:</strong> ${m.text}</p>`).join("");
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Export Rosters
    document.getElementById("btnExport").onclick = () => {
      onValue(ref(db, "users"), snap => {
        const rows = [["Squadra","IdGiocatore","Crediti"]];
        const users = snap.val() || {};
        Object.values(users).forEach(u => {
          ["P","D","C","A"].forEach(r => {
            (u.roster[r] || []).forEach(p => {
              rows.push([u.teamName, p.id, p.quota]);
            });
          });
        });
        const csv = rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "export_rosters.csv";
        a.click();
      }, { onlyOnce: true });
    };

    // Admin Reset
    document.getElementById("btnReset").onclick = () => {
      if (!confirm("Confermi reset asta?")) return;
      remove(ref(db, "bids"));
      remove(ref(db, "users"));
      remove(ref(db, "chat"));
      remove(ref(db, "discarded"));
      showSection("login");
    };

    // Init
    showSection("login");
    await loadPlayers();
    updateTeamsStatus();
  </script>
</body>
</html>
