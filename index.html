<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asta Fantacalcio 2025/26</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header><h1>Asta Fantacalcio 2025/26</h1></header>

  <main>
    <!-- LOGIN -->
    <section id="login">
      <h2>Accedi o Registrati</h2>
      <input id="nickname" placeholder="Nickname" />
      <input id="teamName" placeholder="Nome Squadra" />
      <button id="btnLogin">Entra</button>
    </section>

    <!-- ASTA -->
    <section id="auction" class="hidden">
      <div id="auction-controls">
        <select id="roleSelect">
          <option value="P">Portieri</option>
          <option value="D">Difensori</option>
          <option value="C">Centrocampisti</option>
          <option value="A">Attaccanti</option>
        </select>
        <button id="btnNext">Prossimo</button>
        <button id="btnAssign">Assegna</button>
        <button id="btnDiscard">Scarta</button>
      </div>
      <div id="playerCard">
        <h3 id="playerName"></h3>
        <p id="playerQuota"></p>
      </div>
      <div id="bids">
        <button class="bid-btn" data-incr="1">+1</button>
        <button class="bid-btn" data-incr="5">+5</button>
        <button class="bid-btn" data-incr="10">+10</button>
        <button class="bid-btn" data-incr="50">+50</button>
        <div id="lastBidder" style="margin-top:8px;font-weight:bold"></div>
      </div>
      <div id="bidHistory">
        <h4>Ultimi 5 Rilanci</h4>
        <ul id="historyList"></ul>
      </div>
      <div id="teamsStatus">
        <h4>Crediti Residui</h4>
        <table id="statusTable">
          <thead><tr><th>Squadra</th><th>Crediti</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="chat">
        <h4>Chat Asta</h4>
        <div id="chatMessages"></div>
        <input id="chatInput" placeholder="Scrivi..." />
        <button id="btnSend">Invia</button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <h2>La Mia Squadra</h2>
      <canvas id="budgetChart"></canvas>
      <h3>Dettaglio Rose</h3>
      <table id="rosterTable">
        <thead><tr><th>Ruolo</th><th>Giocatore</th><th>Crediti</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="btnExport">Esporta Rosters</button>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="hidden">
      <h2>Area Admin</h2>
      <button id="btnReset">Reset Asta</button>
    </section>
  </main>

  <script type="module">
    // 1. Config Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const cfg = {
      apiKey: "AIzaSyCQyptj9TKJWtb2R1v81I_w4M8KdhlDbDM",
      authDomain: "astafantacalcio-387cf.firebaseapp.com",
      databaseURL: "https://astafantacalcio-387cf-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "astafantacalcio-387cf",
      storageBucket: "astafantacalcio-387cf.firebasestorage.app",
      messagingSenderId: "826628958189",
      appId: "1:826628958189:web:dd741f447550d3259769e4"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // 2. Elementi DOM
    const loginSec     = document.getElementById("login");
    const auctionSec   = document.getElementById("auction");
    const dashboardSec = document.getElementById("dashboard");
    const adminSec     = document.getElementById("admin");
    const btnLogin     = document.getElementById("btnLogin");

    // helper
    function show(sec) {
      loginSec.classList.toggle("hidden", sec!=="login");
      auctionSec.classList.toggle("hidden", sec!=="auction");
      dashboardSec.classList.toggle("hidden", sec!=="dashboard");
      adminSec.classList.toggle("hidden", sec!=="admin");
    }

    // 3. Autenticazione
    btnLogin.onclick = () => {
      const nick = document.getElementById("nickname").value.trim();
      const team = document.getElementById("teamName").value.trim();
      if (!nick||!team) { alert("Inserisci nickname e squadra"); return; }
      signInAnonymously(auth);
    };
    onAuthStateChanged(auth, user => {
      if (!user) return;
      set(ref(db, `users/${user.uid}`), {
        teamName: document.getElementById("teamName").value.trim(),
        nickname: document.getElementById("nickname").value.trim(),
        budget: 1500,
        roster: { P:[],D:[],C:[],A:[] }
      }).then(() => {
        loadPlayers().then(() => { bindAuction(); bindChat(); bindExport(); });
        bindTeamsStatus();
        show("auction");
      });
    });

    // 4. Auction
    let playersByRole={P:[],D:[],C:[],A:[]}, current=null;
    const roleSel   = document.getElementById("roleSelect");
    const nameEl    = document.getElementById("playerName");
    const quotaEl   = document.getElementById("playerQuota");
    const histList  = document.getElementById("historyList");
    const lastBid   = document.getElementById("lastBidder");

    async function loadPlayers() {
      const txt = await (await fetch("data/players.csv")).text();
      const [hdr,...rows] = txt.trim().split("\n").map(r=>r.split(","));
      const idx = {Id:hdr.indexOf("Id"),R:hdr.indexOf("R"),Nome:hdr.indexOf("Nome"),Squ:hdr.indexOf("Squadra"),Q:hdr.indexOf("QuotaIniziale")};
      rows.forEach(c=>{
        const rec={id:c[idx.Id],role:c[idx.R],nome:c[idx.Nome],squadra:c[idx.Squ],quota:+c[idx.Q]};
        playersByRole[rec.role].push(rec);
      });
    }
    function bindAuction(){
      document.getElementById("btnNext").onclick   = nextP;
      document.getElementById("btnAssign").onclick = assignP;
      document.getElementById("btnDiscard").onclick= discardP;
      document.querySelectorAll(".bid-btn").forEach(b=>b.onclick=()=>bid(+b.dataset.incr));
    }
    function nextP(){
      const list=playersByRole[roleSel.value];
      if(!list.length){alert("Finiti!");return;}
      current=list.splice(Math.random()*list.length|0,1)[0];
      nameEl.textContent=`${current.nome} (${current.squadra})`;
      quotaEl.textContent=`Base: ${current.quota}`;
      histList.innerHTML=""; lastBid.textContent="";
    }
    function bid(incr){
      if(!current) return;
      current.quota+=incr;
      push(ref(db,`bids/${current.id}`),{team:document.getElementById("teamName").value,amount:current.quota,ts:Date.now()})
        .then(refreshHist);
    }
    function refreshHist(){
      onValue(ref(db,`bids/${current.id}`),s=>{
        const a=Object.values(s.val()||{}).sort((x,y)=>y.ts-x.ts).slice(0,5);
        histList.innerHTML=a.map(o=>`<li>${o.team}: ${o.amount}</li>`).join("");
        lastBid.textContent=a[0]?`Ultima offerta: ${a[0].team} â€“ ${a[0].amount}`:"";
      });
    }
    function assignP(){
      if(!current) return;
      onValue(ref(db,`bids/${current.id}`),s=>{
        const bids=Object.values(s.val()||{});
        if(!bids.length){alert("No offerte");return;}
        const w=bids.sort((x,y)=>y.amount-x.amount)[0];
        onValue(ref(db,"users"),us=>{
          const u=Object.entries(us.val()||{}).find(([k,v])=>v.teamName===w.team);
          if(!u){alert("User no");return;}
          const uid=u[0],data=u[1];
          push(ref(db,`users/${uid}/roster/${current.role}`),{id:current.id,nome:current.nome,quota:w.amount});
          update(ref(db,`users/${uid}`),{budget:data.budget-w.amount})
            .then(()=>{updateTeamsStatus();nextP();});
        },{onlyOnce:true});
      },{onlyOnce:true});
    }
    function discardP(){
      if(!current) return;
      push(ref(db,`discarded/${current.role}`),current.id).then(nextP);
    }

    // 5. Teams status
    function bindTeamsStatus(){
      onValue(ref(db,"users"),s=>{
        const t=document.querySelector("#statusTable tbody");
        t.innerHTML=Object.values(s.val()||{}).map(u=>`<tr><td>${u.teamName}</td><td>${u.budget}</td></tr>`).join("");
      });
    }
    function updateTeamsStatus(){ bindTeamsStatus(); }

    // 6. Chat
    function bindChat(){
      const inpt=document.getElementById("chatInput"),box=document.getElementById("chatMessages");
      document.getElementById("btnSend").onclick=()=>{
        const m=inpt.value.trim(); if(!m)return;
        push(ref(db,"chat"),{team:document.getElementById("teamName").value,text:m,ts:Date.now()});
        inpt.value="";
      };
      onValue(ref(db,"chat"),s=>{
        const msgs=Object.values(s.val()||{}).sort((a,b)=>a.ts-b.ts);
        box.innerHTML=msgs.map(m=>`<p><strong>${m.team}:</strong> ${m.text}</p>`).join("");
        box.scrollTop=box.scrollHeight;
      });
    }

    // 7. Export rosters
    function bindExport(){
      document.getElementById("btnExport").onclick=()=>{
        onValue(ref(db,"users"),s=>{
          const rows=[["Squadra","IdGiocatore","Crediti"]];
          Object.values(s.val()||{}).forEach(u=>{
            ["P","D","C","A"].forEach(r=>{
              (u.roster[r]||[]).forEach(p=>rows.push([u.teamName,p.id,p.quota]));
            });
          });
          const csv=rows.map(r=>r.join(",")).join("\n");
          const bl=new Blob([csv],{type:"text/csv"});
          const a=document.createElement("a");a.href=URL.createObjectURL(bl);
          a.download="export_rosters.csv";a.click();
        },{onlyOnce:true});
      };
    }

    // 8. Admin reset
    document.getElementById("btnReset").onclick=()=>{
      if(confirm("Reset?")){
        remove(ref(db,"bids")); remove(ref(db,"users"));
        remove(ref(db,"chat")); remove(ref(db,"discarded"));
        show("login");
      }
    };

    // Inizia mostrando login
    show("login");
  </script>
</body>
</html>
