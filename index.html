<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asta Fantacalcio 2025/26</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header><h1>Asta Fantacalcio 2025/26</h1></header>

  <main>
    <!-- LOGIN -->
    <section id="login">
      <h2>Accedi o Registrati</h2>
      <input id="nickname" placeholder="Nickname" />
      <input id="teamName" placeholder="Nome Squadra" />
      <button id="btnLogin">Entra</button>
    </section>

    <!-- ASTA -->
    <section id="auction" class="hidden">
      <div id="auction-controls">
        <select id="roleSelect">
          <option value="P">Portieri</option>
          <option value="D">Difensori</option>
          <option value="C">Centrocampisti</option>
          <option value="A">Attaccanti</option>
        </select>
        <button id="btnNext">Prossimo</button>
        <button id="btnAssign">Assegna</button>
        <button id="btnDiscard">Scarta</button>
      </div>
      <div id="playerCard">
        <h3 id="playerName"></h3>
        <p id="playerQuota"></p>
      </div>
      <div id="bids">
        <button class="bid-btn" data-incr="1">+1</button>
        <button class="bid-btn" data-incr="5">+5</button>
        <button class="bid-btn" data-incr="10">+10</button>
        <button class="bid-btn" data-incr="50">+50</button>
        <div id="lastBidder" style="margin-top:8px;font-weight:bold"></div>
      </div>
      <div id="bidHistory">
        <h4>Ultimi 5 Rilanci</h4>
        <ul id="historyList"></ul>
      </div>
      <div id="teamsStatus">
        <h4>Crediti Residui</h4>
        <table id="statusTable">
          <thead><tr><th>Squadra</th><th>Crediti</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="chat">
        <h4>Chat Asta</h4>
        <div id="chatMessages"></div>
        <input id="chatInput" placeholder="Scrivi..." />
        <button id="btnSend">Invia</button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <h2>La Mia Squadra</h2>
      <canvas id="budgetChart"></canvas>
      <h3>Dettaglio Rose</h3>
      <table id="rosterTable">
        <thead><tr><th>Ruolo</th><th>Giocatore</th><th>Crediti</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="btnExport">Esporta Rosters</button>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="hidden">
      <h2>Area Admin</h2>
      <button id="btnReset">Reset Asta</button>
    </section>
  </main>

  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCQyptj9TKJWtb2R1v81I_w4M8KdhlDbDM",
      authDomain: "astafantacalcio-387cf.firebaseapp.com",
      databaseURL: "https://astafantacalcio-387cf-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "astafantacalcio-387cf",
      storageBucket: "astafantacalcio-387cf.firebasestorage.app",
      messagingSenderId: "826628958189",
      appId: "1:826628958189:web:dd741f447550d3259769e4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // DOM Elements
    const loginSection   = document.getElementById("login");
    const auctionSection = document.getElementById("auction");
    const dashboardSection = document.getElementById("dashboard");
    const adminSection   = document.getElementById("admin");
    const btnLogin       = document.getElementById("btnLogin");

    // Show/hide sections
    function showSection(name) {
      loginSection.classList.toggle("hidden", name!=="login");
      auctionSection.classList.toggle("hidden", name!=="auction");
      dashboardSection.classList.toggle("hidden", name!=="dashboard");
      adminSection.classList.toggle("hidden", name!=="admin");
    }

    // Authentication
    btnLogin.onclick = () => {
      signInAnonymously(auth);
    };
    onAuthStateChanged(auth, async user => {
      if (!user) return;
      // Register user in DB
      const nick = document.getElementById("nickname").value.trim();
      const team = document.getElementById("teamName").value.trim();
      await set(ref(db, `users/${user.uid}`), {
        nickname: nick,
        teamName: team,
        budget: 1500,
        roster: { P:[],D:[],C:[],A:[] }
      });
      // Initialize modules
      initAuction();
      initChat();
      initExport();
      bindTeamsStatus();
      showSection("auction");
    });

    // Auction module
    let playersByRole = { P:[], D:[], C:[], A:[] };
    let currentPlayer = null;
    const roleSelect   = document.getElementById("roleSelect");
    const playerNameEl = document.getElementById("playerName");
    const playerQuotaEl= document.getElementById("playerQuota");
    const historyList  = document.getElementById("historyList");
    const lastBidderEl = document.getElementById("lastBidder");

    async function loadPlayers() {
      const resp = await fetch("data/players.csv");
      const text = await resp.text();
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      const idx = {
        Id: headers.indexOf("Id"),
        R: headers.indexOf("R"),
        Nome: headers.indexOf("Nome"),
        Squadra: headers.indexOf("Squadra"),
        Quota: headers.indexOf("QuotaIniziale")
      };
      lines.slice(1).forEach(row => {
        const cols = row.split(",");
        const rec = {
          id: cols[idx.Id],
          role: cols[idx.R],
          nome: cols[idx.Nome],
          squadra: cols[idx.Squadra],
          quota: Number(cols[idx.Quota])
        };
        playersByRole[rec.role].push(rec);
      });
    }

    function bindAuction() {
      document.getElementById("btnNext").onclick = pickNextPlayer;
      document.getElementById("btnAssign").onclick = assignPlayer;
      document.getElementById("btnDiscard").onclick = discardPlayer;
      document.querySelectorAll(".bid-btn").forEach(btn =>
        btn.onclick = () => placeBid(+btn.dataset.incr)
      );
    }

    async function initAuction() {
      await loadPlayers();
      bindAuction();
    }

    function pickNextPlayer() {
      const list = playersByRole[roleSelect.value];
      if (!list || !list.length) { alert("Nessun giocatore rimasto"); return; }
      currentPlayer = list.splice(Math.floor(Math.random()*list.length),1)[0];
      playerNameEl.textContent = `${currentPlayer.nome} (${currentPlayer.squadra})`;
      playerQuotaEl.textContent = `Base: ${currentPlayer.quota}`;
      historyList.innerHTML = "";
      lastBidderEl.textContent = "";
    }

    function placeBid(incr) {
      if (!currentPlayer) return;
      currentPlayer.quota += incr;
      push(ref(db, `bids/${currentPlayer.id}`), {
        team: document.getElementById("teamName").value,
        amount: currentPlayer.quota,
        ts: Date.now()
      }).then(refreshHistory);
    }

    function refreshHistory() {
      onValue(ref(db, `bids/${currentPlayer.id}`), snap => {
        const arr = Object.values(snap.val()||{}).sort((a,b)=>b.ts-a.ts).slice(0,5);
        historyList.innerHTML = arr.map(b => `<li>${b.team}: ${b.amount}</li>`).join("");
        lastBidderEl.textContent = arr[0] ? `Ultima offerta: ${arr[0].team} â€“ ${arr[0].amount}` : "";
      });
    }

    function assignPlayer() {
      if (!currentPlayer) return;
      onValue(ref(db, `bids/${currentPlayer.id}`), snap => {
        const bids = Object.values(snap.val()||{});
        if (!bids.length) { alert("Nessuna offerta"); return; }
        const winner = bids.sort((a,b)=>b.amount-a.amount)[0];
        onValue(ref(db, "users"), userSnap => {
          const users = userSnap.val()||{};
          const uid = Object.keys(users).find(k=>users[k].teamName===winner.team);
          if (!uid) { alert("Utente non trovato"); return; }
          push(ref(db, `users/${uid}/roster/${currentPlayer.role}`), {
            id: currentPlayer.id,
            nome: currentPlayer.nome,
            squadra: currentPlayer.squadra,
            quota: winner.amount
          });
          update(ref(db, `users/${uid}`), { budget: users[uid].budget - winner.amount })
            .then(() => { bindTeamsStatus(); pickNextPlayer(); });
        }, { onlyOnce: true });
      }, { onlyOnce: true });
    }

    function discardPlayer() {
      if (!currentPlayer) return;
      push(ref(db, `discarded/${currentPlayer.role}`), currentPlayer.id)
        .then(pickNextPlayer);
    }

    // Teams status
    function bindTeamsStatus() {
      onValue(ref(db, "users"), snap => {
        const tbody = document.querySelector("#statusTable tbody");
        const users = snap.val()||{};
        tbody.innerHTML = Object.values(users)
          .map(u=>`<tr><td>${u.teamName}</td><td>${u.budget}</td></tr>`)
          .join("");
      });
    }

    // Chat module
    function initChat() {
      const chatInput = document.getElementById("chatInput");
      const chatBox = document.getElementById("chatMessages");
      document.getElementById("btnSend").onclick = () => {
        const text = chatInput.value.trim();
        if (!text) return;
        push(ref(db, "chat"), {
          team: document.getElementById("teamName").value,
          text,
          ts: Date.now()
        });
        chatInput.value = "";
      };
      onValue(ref(db, "chat"), snap => {
        const msgs = Object.values(snap.val()||{}).sort((a,b)=>a.ts-b.ts);
        chatBox.innerHTML = msgs.map(m => `<p><strong>${m.team}:</strong> ${m.text}</p>`).join("");
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    // Export module
    function initExport() {
      document.getElementById("btnExport").onclick = () => {
        onValue(ref(db, "users"), snap => {
          const rows = [["Squadra","IdGiocatore","Crediti"]];
          Object.values(snap.val()||{}).forEach(u => {
            ["P","D","C","A"].forEach(r => {
              (u.roster[r]||[]).forEach(p => rows.push([u.teamName,p.id,p.quota]));
            });
          });
          const csv = rows.map(r=>r.join(",")).join("\n");
          const blob = new Blob([csv], { type:"text/csv" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "export_rosters.csv";
          a.click();
        }, { onlyOnce: true });
      };
    }

    // Admin reset
    document.getElementById("btnReset").onclick = () => {
      if (confirm("Confermi reset asta?")) {
        remove(ref(db, "bids"));
        remove(ref(db, "users"));
        remove(ref(db, "chat"));
        remove(ref(db, "discarded"));
        showSection("login");
      }
    };

    // Start at login
    showSection("login");
  </script>
</body>
</html>
